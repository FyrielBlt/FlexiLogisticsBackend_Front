"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.install = void 0;

var _middlewarePipeline = require("./core/middlewarePipeline");

var _prepareMiddlewareiPiplinePayload = require("./helpers/prepareMiddlewareiPiplinePayload");

var _InvalidOptions = require("./lib/Exceptions/InvalidOptions");

function _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }

function _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

var install = function install(vue, options) {
  if (_typeof(options) !== 'object') {
    throw new _InvalidOptions.InvalidOptions();
  } // ==== helpers ============


  var app = {};
  var router;
  var globalMiddlewares = [];
  var context = {
    app: app
  };

  if (options && options.router) {
    // if options object
    var _ref = options,
        _router = _ref.router,
        middleware = _ref.middleware,
        _context = _ref.context;
    router = _router;
    /* istanbul ignore if */

    if (middleware !== undefined) {
      globalMiddlewares = (0, _prepareMiddlewareiPiplinePayload.prepareMiddlewarePipelinePayload)(middleware);
    }

    if (_context !== undefined) {
      /* istanbul ignore if */
      if (_typeof(_context) === 'object') {
        context = _objectSpread({}, _context, {}, context);
      } else {
        throw new _InvalidOptions.InvalidOptions('invalid context');
      }
    }
  } else if (options.router === undefined && options.beforeEach === undefined) {
    // if options is not object and not router
    throw new _InvalidOptions.InvalidOptions('router is a required option.');
  } else {
    // if options is router
    router = options;
  }
  /* istanbul ignore next */


  var routeHook = function routeHook(to, from, next) {
    var middlewares = _toConsumableArray(globalMiddlewares);

    if ('middleware' in to.meta) {
      if (_typeof(to.meta.middleware) === 'object') {
        var ignores = [];

        if ('attach' in to.meta.middleware) {
          middlewares = (0, _prepareMiddlewareiPiplinePayload.prepareMiddlewarePipelinePayload)(to.meta.middleware.attach, middlewares);
        }

        if ('ignore' in to.meta.middleware) {
          ignores = (0, _prepareMiddlewareiPiplinePayload.prepareMiddlewarePipelinePayload)(to.meta.middleware.ignore);
        }

        middlewares = middlewares.filter(function (middleware) {
          return !ignores.includes(middleware);
        });
      } else {
        middlewares = (0, _prepareMiddlewareiPiplinePayload.prepareMiddlewarePipelinePayload)(to.meta.middleware, middlewares);
      }
    }

    if (middlewares.length) {
      context = _objectSpread({}, context, {
        to: to,
        from: from,
        next: next
      });
      (0, _middlewarePipeline.middlewarePipeline)(context, middlewares);
    } else {
      next();
    }
  };

  router.beforeEach(routeHook);
  app.$MiddlewarePlugin = true;

  app.$getMiddlewareContext = function () {
    var _context2 = context,
        app = _context2.app,
        _context = _objectWithoutProperties(_context2, ["app"]);

    return _context;
  };

  app.$setMiddlewareContext = function (_context) {
    var _context3 = context,
        app = _context3.app,
        to = _context3.to,
        from = _context3.from,
        redirect = _context3.redirect;
    context = _objectSpread({}, _context, {
      app: app,
      to: to,
      from: from,
      redirect: redirect
    });
    return context;
  };

  app.$updateMiddlewareContext = function (key, value) {
    var _context5;

    var _context4 = context,
        app = _context4.app,
        to = _context4.to,
        from = _context4.from,
        redirect = _context4.redirect;
    context = (_context5 = {}, _defineProperty(_context5, key, value), _defineProperty(_context5, "app", app), _defineProperty(_context5, "to", to), _defineProperty(_context5, "from", from), _defineProperty(_context5, "redirect", redirect), _context5);
  };
};

exports.install = install;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbnN0YWxsLnRzIl0sIm5hbWVzIjpbImluc3RhbGwiLCJ2dWUiLCJvcHRpb25zIiwiSW52YWxpZE9wdGlvbnMiLCJhcHAiLCJyb3V0ZXIiLCJnbG9iYWxNaWRkbGV3YXJlcyIsImNvbnRleHQiLCJfcm91dGVyIiwibWlkZGxld2FyZSIsIl9jb250ZXh0IiwidW5kZWZpbmVkIiwiYmVmb3JlRWFjaCIsInJvdXRlSG9vayIsInRvIiwiZnJvbSIsIm5leHQiLCJtaWRkbGV3YXJlcyIsIm1ldGEiLCJpZ25vcmVzIiwiYXR0YWNoIiwiaWdub3JlIiwiZmlsdGVyIiwiaW5jbHVkZXMiLCJsZW5ndGgiLCIkTWlkZGxld2FyZVBsdWdpbiIsIiRnZXRNaWRkbGV3YXJlQ29udGV4dCIsIiRzZXRNaWRkbGV3YXJlQ29udGV4dCIsInJlZGlyZWN0IiwiJHVwZGF0ZU1pZGRsZXdhcmVDb250ZXh0Iiwia2V5IiwidmFsdWUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQVlPLElBQU1BLE9BQXdDLEdBQUcsU0FBM0NBLE9BQTJDLENBQ3REQyxHQURzRCxFQUV0REMsT0FGc0QsRUFHbkQ7QUFDSCxNQUFJLFFBQU9BLE9BQVAsTUFBbUIsUUFBdkIsRUFBaUM7QUFDL0IsVUFBTSxJQUFJQyw4QkFBSixFQUFOO0FBQ0QsR0FIRSxDQUtIOzs7QUFDQSxNQUFNQyxHQUFRLEdBQUcsRUFBakI7QUFFQSxNQUFJQyxNQUFKO0FBQ0EsTUFBSUMsaUJBQStCLEdBQUcsRUFBdEM7QUFDQSxNQUFJQyxPQUFxQixHQUFHO0FBQUVILElBQUFBLEdBQUcsRUFBSEE7QUFBRixHQUE1Qjs7QUFFQSxNQUFJRixPQUFPLElBQUtBLE9BQUQsQ0FBMkJHLE1BQTFDLEVBQWtEO0FBQ2hEO0FBRGdELGVBTTVDSCxPQU40QztBQUFBLFFBR3RDTSxPQUhzQyxRQUc5Q0gsTUFIOEM7QUFBQSxRQUk5Q0ksVUFKOEMsUUFJOUNBLFVBSjhD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LEVBQXdCO0FBQUEsb0JBQ2RILE9BRGM7QUFBQSxRQUMxQ0gsR0FEMEMsYUFDMUNBLEdBRDBDO0FBQUEsUUFDckNVLEVBRHFDLGFBQ3JDQSxFQURxQztBQUFBLFFBQ2pDQyxJQURpQyxhQUNqQ0EsSUFEaUM7QUFBQSxRQUMzQmEsUUFEMkIsYUFDM0JBLFFBRDJCO0FBRWxEckIsSUFBQUEsT0FBTyxxQkFBUUcsUUFBUjtBQUFrQk4sTUFBQUEsR0FBRyxFQUFIQSxHQUFsQjtBQUF1QlUsTUFBQUEsRUFBRSxFQUFGQSxFQUF2QjtBQUEyQkMsTUFBQUEsSUFBSSxFQUFKQSxJQUEzQjtBQUFpQ2EsTUFBQUEsUUFBUSxFQUFSQTtBQUFqQyxNQUFQO0FBQ0EsV0FBT3JCLE9BQVA7QUFDRCxHQUpEOztBQUtBSCxFQUFBQSxHQUFHLENBQUN5Qix3QkFBSixHQUErQixVQUFDQyxHQUFELEVBQWNDLEtBQWQsRUFBNkI7QUFBQTs7QUFBQSxvQkFDdEJ4QixPQURzQjtBQUFBLFFBQ2xESCxHQURrRCxhQUNsREEsR0FEa0Q7QUFBQSxRQUM3Q1UsRUFENkMsYUFDN0NBLEVBRDZDO0FBQUEsUUFDekNDLElBRHlDLGFBQ3pDQSxJQUR5QztBQUFBLFFBQ25DYSxRQURtQyxhQUNuQ0EsUUFEbUM7QUFFMURyQixJQUFBQSxPQUFPLCtDQUFNdUIsR0FBTixFQUFZQyxLQUFaLHFDQUFtQjNCLEdBQW5CLG9DQUF3QlUsRUFBeEIsc0NBQTRCQyxJQUE1QiwwQ0FBa0NhLFFBQWxDLGFBQVA7QUFDRCxHQUhEO0FBSUQsQ0FwR00iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBtaWRkbGV3YXJlUGlwZWxpbmUgfSBmcm9tICcuL2NvcmUvbWlkZGxld2FyZVBpcGVsaW5lJ1xuaW1wb3J0IHsgcHJlcGFyZU1pZGRsZXdhcmVQaXBlbGluZVBheWxvYWQgYXMgcHJlcGFyZVBpcGVsaW5lUGF5bG9hZCB9IGZyb20gJy4vaGVscGVycy9wcmVwYXJlTWlkZGxld2FyZWlQaXBsaW5lUGF5bG9hZCdcbmltcG9ydCB7IEludmFsaWRPcHRpb25zIH0gZnJvbSAnLi9saWIvRXhjZXB0aW9ucy9JbnZhbGlkT3B0aW9ucydcbmltcG9ydCB7IE1pZGRsZXdhcmUgfSBmcm9tICcuL3R5cGVzL01pZGRsZXdhcmVUeXBlcydcbmltcG9ydCB7IEluc3RhbGwsIFBsdWdpbk9wdGlvbnMgfSBmcm9tICcuL3R5cGVzL1BsdWdpblR5cGVzJ1xuaW1wb3J0IHtcbiAgUm91dGUsXG4gIFJvdXRlQ29udGV4dCxcbiAgUm91dGVIb29rLFxuICBSb3V0ZXIsXG4gIFJvdXRlUmVzb2x2ZXIsXG4gIFZ1ZVxufSBmcm9tICcuL3R5cGVzL1Z1ZVR5cGVzJ1xuXG5leHBvcnQgY29uc3QgaW5zdGFsbDogSW5zdGFsbDxSb3V0ZXIgfCBQbHVnaW5PcHRpb25zPiA9IChcbiAgdnVlOiBWdWUsXG4gIG9wdGlvbnM/OiBSb3V0ZXIgfCBQbHVnaW5PcHRpb25zXG4pID0+IHtcbiAgaWYgKHR5cGVvZiBvcHRpb25zICE9PSAnb2JqZWN0Jykge1xuICAgIHRocm93IG5ldyBJbnZhbGlkT3B0aW9ucygpXG4gIH1cblxuICAvLyA9PT09IGhlbHBlcnMgPT09PT09PT09PT09XG4gIGNvbnN0IGFwcDogYW55ID0ge31cblxuICBsZXQgcm91dGVyOiBSb3V0ZXJcbiAgbGV0IGdsb2JhbE1pZGRsZXdhcmVzOiBNaWRkbGV3YXJlW10gPSBbXVxuICBsZXQgY29udGV4dDogUm91dGVDb250ZXh0ID0geyBhcHAgfVxuXG4gIGlmIChvcHRpb25zICYmIChvcHRpb25zIGFzIFBsdWdpbk9wdGlvbnMpLnJvdXRlcikge1xuICAgIC8vIGlmIG9wdGlvbnMgb2JqZWN0XG4gICAgY29uc3Qge1xuICAgICAgcm91dGVyOiBfcm91dGVyLFxuICAgICAgbWlkZGxld2FyZSxcbiAgICAgIGNvbnRleHQ6IF9jb250ZXh0XG4gICAgfSA9IG9wdGlvbnMgYXMgUGx1Z2luT3B0aW9uc1xuICAgIHJvdXRlciA9IF9yb3V0ZXJcblxuICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqL1xuICAgIGlmIChtaWRkbGV3YXJlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGdsb2JhbE1pZGRsZXdhcmVzID0gcHJlcGFyZVBpcGVsaW5lUGF5bG9hZChtaWRkbGV3YXJlKVxuICAgIH1cblxuICAgIGlmIChfY29udGV4dCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi9cbiAgICAgIGlmICh0eXBlb2YgX2NvbnRleHQgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIGNvbnRleHQgPSB7IC4uLl9jb250ZXh0LCAuLi5jb250ZXh0IH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkT3B0aW9ucygnaW52YWxpZCBjb250ZXh0JylcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSBpZiAoXG4gICAgKG9wdGlvbnMgYXMgUGx1Z2luT3B0aW9ucykucm91dGVyID09PSB1bmRlZmluZWQgJiZcbiAgICAob3B0aW9ucyBhcyBSb3V0ZXIpLmJlZm9yZUVhY2ggPT09IHVuZGVmaW5lZFxuICApIHtcbiAgICAvLyBpZiBvcHRpb25zIGlzIG5vdCBvYmplY3QgYW5kIG5vdCByb3V0ZXJcbiAgICB0aHJvdyBuZXcgSW52YWxpZE9wdGlvbnMoJ3JvdXRlciBpcyBhIHJlcXVpcmVkIG9wdGlvbi4nKVxuICB9IGVsc2Uge1xuICAgIC8vIGlmIG9wdGlvbnMgaXMgcm91dGVyXG4gICAgcm91dGVyID0gb3B0aW9ucyBhcyBSb3V0ZXJcbiAgfVxuXG4gIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG4gIGNvbnN0IHJvdXRlSG9vazogUm91dGVIb29rID0gKFxuICAgIHRvOiBSb3V0ZSxcbiAgICBmcm9tOiBSb3V0ZSxcbiAgICBuZXh0OiBSb3V0ZVJlc29sdmVyXG4gICkgPT4ge1xuICAgIGxldCBtaWRkbGV3YXJlcyA9IFsuLi5nbG9iYWxNaWRkbGV3YXJlc11cbiAgICBpZiAoJ21pZGRsZXdhcmUnIGluIHRvLm1ldGEpIHtcbiAgICAgIGlmICh0eXBlb2YgdG8ubWV0YS5taWRkbGV3YXJlID09PSAnb2JqZWN0Jykge1xuICAgICAgICBsZXQgaWdub3JlczogTWlkZGxld2FyZVtdID0gW11cbiAgICAgICAgaWYgKCdhdHRhY2gnIGluIHRvLm1ldGEubWlkZGxld2FyZSkge1xuICAgICAgICAgIG1pZGRsZXdhcmVzID0gcHJlcGFyZVBpcGVsaW5lUGF5bG9hZChcbiAgICAgICAgICAgIHRvLm1ldGEubWlkZGxld2FyZS5hdHRhY2gsXG4gICAgICAgICAgICBtaWRkbGV3YXJlc1xuICAgICAgICAgIClcbiAgICAgICAgfVxuICAgICAgICBpZiAoJ2lnbm9yZScgaW4gdG8ubWV0YS5taWRkbGV3YXJlKSB7XG4gICAgICAgICAgaWdub3JlcyA9IHByZXBhcmVQaXBlbGluZVBheWxvYWQodG8ubWV0YS5taWRkbGV3YXJlLmlnbm9yZSlcbiAgICAgICAgfVxuXG4gICAgICAgIG1pZGRsZXdhcmVzID0gbWlkZGxld2FyZXMuZmlsdGVyKFxuICAgICAgICAgIG1pZGRsZXdhcmUgPT4gIWlnbm9yZXMuaW5jbHVkZXMobWlkZGxld2FyZSlcbiAgICAgICAgKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbWlkZGxld2FyZXMgPSBwcmVwYXJlUGlwZWxpbmVQYXlsb2FkKHRvLm1ldGEubWlkZGxld2FyZSwgbWlkZGxld2FyZXMpXG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKG1pZGRsZXdhcmVzLmxlbmd0aCkge1xuICAgICAgY29udGV4dCA9IHsgLi4uY29udGV4dCwgdG8sIGZyb20sIG5leHQgfVxuICAgICAgbWlkZGxld2FyZVBpcGVsaW5lKGNvbnRleHQsIG1pZGRsZXdhcmVzKVxuICAgIH0gZWxzZSB7XG4gICAgICBuZXh0KClcbiAgICB9XG4gIH1cblxuICByb3V0ZXIuYmVmb3JlRWFjaChyb3V0ZUhvb2spXG5cbiAgYXBwLiRNaWRkbGV3YXJlUGx1Z2luID0gdHJ1ZVxuICBhcHAuJGdldE1pZGRsZXdhcmVDb250ZXh0ID0gKCkgPT4ge1xuICAgIGNvbnN0IHsgYXBwLCAuLi5fY29udGV4dCB9ID0gY29udGV4dFxuICAgIHJldHVybiBfY29udGV4dFxuICB9XG4gIGFwcC4kc2V0TWlkZGxld2FyZUNvbnRleHQgPSAoX2NvbnRleHQ6IGFueSk6IGFueSA9PiB7XG4gICAgY29uc3QgeyBhcHAsIHRvLCBmcm9tLCByZWRpcmVjdCB9ID0gY29udGV4dFxuICAgIGNvbnRleHQgPSB7IC4uLl9jb250ZXh0LCBhcHAsIHRvLCBmcm9tLCByZWRpcmVjdCB9XG4gICAgcmV0dXJuIGNvbnRleHRcbiAgfVxuICBhcHAuJHVwZGF0ZU1pZGRsZXdhcmVDb250ZXh0ID0gKGtleTogc3RyaW5nLCB2YWx1ZTogYW55KSA9PiB7XG4gICAgY29uc3QgeyBhcHAsIHRvLCBmcm9tLCByZWRpcmVjdCB9ID0gY29udGV4dFxuICAgIGNvbnRleHQgPSB7IFtrZXldOiB2YWx1ZSwgYXBwLCB0bywgZnJvbSwgcmVkaXJlY3QgfVxuICB9XG59XG4iXX0=